# 智能上下文管理功能

## 功能概述

当对话历史接近模型的token限制时，系统会自动总结历史对话内容并开启新对话窗口，实现历史记录的累积保存和无缝对话体验。

## 工作原理

### 1. 双重检测机制
- **预检查（85%）**: 在添加用户问题前检查，如果超过85%先进行总结
- **后检查（80%）**: AI回复后检查，如果超过80%为下次对话做准备
- 确保用户问题不会丢失，AI回复能完整显示

### 2. 智能总结策略
- **大模型总结**: 使用当前配置的LLM对每轮对话进行智能压缩
- **JSON格式存储**: 将对话压缩为 `[{"q":"问题概括","a":"答案要点"}]` 格式
- **历史累积**: 新总结会包含之前所有轮次的历史记录
- **过滤优化**: 自动过滤工具调用的中间过程，只保留最终答案

### 3. 新对话窗口
- **自动开启**: 总结完成后自动开启新对话窗口
- **历史传递**: 累积的历史记录会传递到新窗口
- **问题续传**: 预检查触发时，用户的新问题会自动发送到新窗口
- **Token重置**: 新窗口的token计数从历史记录开始重新计算

### 4. 溢出保护
- **长度检测**: 如果累积历史记录超过80% token限制
- **用户提示**: 在新窗口显示警告，建议手动新开干净窗口
- **记录限制**: 最多保留15条历史问答记录，超过自动删除最早的

## 用户体验

### 旧窗口显示
- 显示"🆕 已开启新对话"提示
- 说明上下文总结已传递到新对话
- 输入框变为只读状态，保留为历史记录

### 新窗口显示
- **欢迎信息**: "✨ 新对话已开始"，显示token重置信息
- **历史记忆**: "📋 上一轮对话记忆"，显示累积的历史总结
- **溢出警告**: 如果历史过长，显示"⚠️ 历史记录过长"警告
- **自动续问**: 如果有待处理问题，自动发送并获得回答

### 降级处理
- 如果大模型总结失败，降级到简单文本截取
- 如果总结过程出错，使用关键词提取作为备用方案
- 确保系统在任何情况下都能正常工作

## 技术实现

### 核心组件
- `ContextManager.needsContextSummarization()` - 检测是否需要总结
- `ContextManager.getMessagesForSummarization()` - 获取需要总结的消息和历史记录
- `ContextManager.applySummarization()` - 应用JSON格式的累积总结
- `AgentEngine.performContextSummarization()` - 执行大模型总结和新窗口切换

### 事件类型
```typescript
// 总结完成事件
{ 
  type: 'context_summarized'; 
  summary: string; 
  summarizedCount: number;
  hasHistorySummary?: boolean;
}

// 新对话事件
{ 
  type: 'new_conversation_with_summary'; 
  summary: string; 
  summarizedCount: number;
  pendingUserMessage?: string;
  isOverflow?: boolean;
}

// 溢出警告事件
{ 
  type: 'context_overflow'; 
  message: string; 
  summaryTokens: number; 
  tokenLimit: number;
}
```

### 总结格式
```json
[
  {"q": "楚云飞是哪里人", "a": "楚云飞是山西人"},
  {"q": "什么是数字滤波器", "a": "数字滤波器是一种对数字信号进行处理的算法或系统"},
  {"q": "德国的首都是哪里", "a": "德国的首都是柏林"}
]
```

## 配置参数

- **预检查阈值**: 85% token使用率
- **后检查阈值**: 80% token使用率  
- **溢出警告阈值**: 80% token使用率（针对累积历史）
- **保留消息数**: 最近2条消息（问答对）
- **历史记录限制**: 最多15条问答记录
- **总结温度**: 0.3 (确保总结准确性)
- **总结长度**: 最多500 tokens

## 优势

1. **无缝体验**: 用户问题永不丢失，对话自然延续
2. **历史累积**: 所有对话历史都会被智能压缩保存
3. **智能总结**: 大模型提取核心信息，过滤无用过程
4. **自动管理**: 完全自动化，无需用户手动操作
5. **溢出保护**: 当历史过长时主动提醒用户
6. **多轮支持**: 支持无限轮对话切换，历史永不丢失
7. **降级稳定**: 多重降级方案确保系统稳定性

## 使用场景

- **长期项目讨论**: 跨多个会话的项目开发和讨论
- **学习记录**: 持续的学习对话，知识点累积
- **问题解决**: 复杂问题的多轮分析和解决
- **代码开发**: 长期的代码开发和调试会话

这个功能实现了真正的"无限对话"体验，让AI助手能够记住所有历史交互，提供更加智能和连续的服务。