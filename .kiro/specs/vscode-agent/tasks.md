# 实现计划

- [x] 1. 项目初始化和核心接口定义
  - [x] 1.1 初始化 VSCode 扩展项目
    - 创建 package.json 扩展清单
    - 配置 tsconfig.json
    - 设置 ESLint 和 Prettier
    - 安装依赖: vscode, fast-check, typescript
    - _需求: 1.1_
  - [x] 1.2 定义核心 TypeScript 接口
    - 创建 src/types/agent.ts (AgentEngine, AgentMode, AgentState, AgentEvent)
    - 创建 src/types/tool.ts (Tool, ToolParameter, ToolResult, ToolRegistry)
    - 创建 src/types/llm.ts (LLMAdapter, LLMMessage, LLMOptions, LLMProvider)
    - 创建 src/types/context.ts (ContextManager, Message)
    - 创建 src/types/conversation.ts (Conversation, ConversationSerializer)
    - 创建 src/types/plan.ts (Plan, PlanStep, PlanExecutor)
    - _需求: 2.1, 3.1, 4.1, 7.1_

- [x] 2. 实现对话序列化器
  - [x] 2.1 创建 ConversationSerializer 类
    - 实现 serialize() 方法将 Conversation 转换为 JSON 字符串
    - 实现 deserialize() 方法将 JSON 字符串解析为 Conversation
    - 实现 exportReadable() 方法导出人类可读格式
    - 处理模式版本控制以保持向后兼容
    - _需求: 11.1, 11.2, 11.3, 11.4, 11.5_
  - [ ]* 2.2 编写序列化往返属性测试
    - **属性 1: 对话序列化往返一致性**
    - **验证: 需求 11.1, 11.2, 11.3**
  - [ ]* 2.3 编写 ConversationSerializer 单元测试
    - 测试各种消息类型的序列化
    - 测试有效和无效 JSON 的反序列化
    - 测试可读格式导出
    - 测试旧版本模式的向后兼容性
    - _需求: 11.1, 11.2, 11.3, 11.4, 11.5_

- [x] 3. 实现上下文管理器
  - [x] 3.1 创建 ContextManager 类
    - 实现 addMessage() 添加消息到历史
    - 实现 getContext() 在 token 限制内获取消息
    - 实现 clear() 重置上下文
    - 实现 getHistory() 获取完整消息历史
    - 使用 tiktoken 或简单启发式实现 token 估算
    - _需求: 7.1, 7.2, 7.4, 7.5_
  - [ ]* 3.2 编写上下文完整性属性测试
    - **属性 12: 上下文完整性**
    - **验证: 需求 7.1, 7.5**
  - [ ]* 3.3 编写上下文 token 限制属性测试
    - **属性 13: 上下文 Token 限制合规**
    - **验证: 需求 7.2**
  - [ ]* 3.4 编写上下文清除属性测试
    - **属性 14: 上下文清除完整性**
    - **验证: 需求 7.4**
  - [ ]* 3.5 编写 ContextManager 单元测试
    - 测试消息添加和获取
    - 测试 token 限制截断保留最近消息
    - 测试清除功能
    - _需求: 7.1, 7.2, 7.4_

- [ ] 4. 检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户。

- [x] 5. 实现工具系统
  - [x] 5.1 创建 ToolRegistry 类
    - 实现 register() 添加工具
    - 实现 get() 按名称获取工具
    - 实现 list() 获取所有工具
    - 实现 getToolDescriptions() 生成 LLM 提示
    - _需求: 2.3, 4.1, 4.2, 4.3, 4.4, 5.1_
  - [x] 5.2 实现 FileReadTool
    - 读取带行号的文件内容
    - 处理文件未找到和权限错误
    - 强制工作区边界
    - _需求: 4.1, 5.5_
  - [x] 5.3 实现 FileWriteTool
    - 写入内容到文件
    - 需要时创建父目录
    - 强制工作区边界
    - _需求: 4.2, 5.5_
  - [x] 5.4 实现 GrepSearchTool
    - 使用正则表达式搜索文件中的模式
    - 返回带上下文行的匹配结果
    - 强制工作区边界
    - _需求: 4.3, 5.5_
  - [x] 5.5 实现 FileSearchTool
    - 按名称模式搜索文件
    - 返回匹配的文件路径
    - 强制工作区边界
    - _需求: 4.4, 5.5_
  - [x] 5.6 实现 ShellCommandTool
    - 使用工作目录执行 shell 命令
    - 捕获 stdout 和 stderr
    - 处理超时
    - 强制工作区边界
    - _需求: 5.1, 5.2, 5.3, 5.5_
  - [ ]* 5.7 编写行动工具有效性属性测试
    - **属性 3: 行动工具有效性**
    - **验证: 需求 2.3**
  - [ ]* 5.8 编写搜索结果属性测试
    - **属性 8: 搜索结果包含模式**
    - **验证: 需求 4.3**
  - [ ]* 5.9 编写文件搜索属性测试
    - **属性 9: 文件搜索返回匹配路径**
    - **验证: 需求 4.4**
  - [ ]* 5.10 编写命令输出属性测试
    - **属性 10: 命令输出捕获**
    - **验证: 需求 5.2**
  - [ ]* 5.11 编写工作区边界属性测试
    - **属性 11: 工作区边界强制**
    - **验证: 需求 5.5**
  - [ ]* 5.12 编写工具系统单元测试
    - 测试 ToolRegistry 操作
    - 测试每个工具的有效输入
    - 测试每个工具的错误处理
    - _需求: 4.1, 4.2, 4.3, 4.4, 5.1, 5.2_

- [ ] 6. 检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户。

- [x] 7. 实现 LLM 适配层
  - [x] 7.1 创建基础 LLMAdapter 接口实现
    - 定义 streamComplete 和 complete 抽象方法
    - 实现 token 估算
    - _需求: 6.1, 6.4, 10.1_
  - [x] 7.2 实现 OpenAI 提供商
    - 创建 OpenAIAdapter 类
    - 使用 Server-Sent Events 实现流式传输
    - 处理 API 错误和速率限制
    - _需求: 6.1, 6.2, 6.3, 10.1_
  - [x] 7.3 实现 Anthropic 提供商
    - 创建 AnthropicAdapter 类
    - 实现流式传输
    - 处理 API 错误
    - _需求: 6.1, 6.2, 6.3, 10.1_
  - [ ]* 7.4 编写流式 token 传递属性测试
    - **属性 15: 流式 Token 传递**
    - **验证: 需求 10.1**
  - [ ]* 7.5 编写流式取消属性测试
    - **属性 16: 流式取消保留部分内容**
    - **验证: 需求 10.3**
  - [ ]* 7.6 编写 LLM 适配器单元测试
    - 测试配置验证
    - 测试错误处理
    - 测试流式行为
    - _需求: 6.2, 6.3, 10.1, 10.3_

- [x] 8. 实现 ReAct 模式
  - [x] 8.1 创建 ReActExecutor 类
    - 实现带思考-行动-观察循环的 execute() 方法
    - 解析 LLM 输出提取思考和行动
    - 执行选定工具并捕获观察结果
    - 处理最大迭代限制
    - 为每一步发出 AgentEvents
    - _需求: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6_
  - [ ]* 8.2 编写 ReAct 循环结构属性测试
    - **属性 2: ReAct 循环结构不变性**
    - **验证: 需求 2.1, 2.2**
  - [ ]* 8.3 编写 ReAct 终止属性测试
    - **属性 4: ReAct 以答案终止**
    - **验证: 需求 2.5**
  - [ ]* 8.4 编写 ReActExecutor 单元测试
    - 测试思考-行动-观察序列
    - 测试工具选择和执行
    - 测试最大迭代处理
    - 测试取消
    - _需求: 2.1, 2.2, 2.3, 2.5, 2.6_

- [x] 9. 实现 Plan 模式
  - [x] 9.1 创建 PlanExecutor 类
    - 实现 createPlan() 从目标生成结构化计划
    - 实现 executePlan() 按顺序运行步骤
    - 处理步骤失败并暂停请求用户指导
    - 支持计划修改同时保留已完成工作
    - 为计划和步骤进度发出 AgentEvents
    - _需求: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6_
  - [ ]* 9.2 编写计划结构属性测试
    - **属性 5: 计划结构完整性**
    - **验证: 需求 3.2**
  - [ ]* 9.3 编写计划顺序执行属性测试
    - **属性 6: 计划顺序执行**
    - **验证: 需求 3.3**
  - [ ]* 9.4 编写计划修改属性测试
    - **属性 7: 计划修改保留已完成工作**
    - **验证: 需求 3.5**
  - [ ]* 9.5 编写 PlanExecutor 单元测试
    - 测试计划生成
    - 测试顺序执行
    - 测试步骤失败处理
    - 测试计划修改
    - _需求: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6_

- [ ] 10. 检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户。

- [x] 11. 实现 Agent 引擎
  - [x] 11.1 创建 AgentEngine 类
    - 实现 processMessage() 处理用户输入
    - 根据 AgentMode 路由到 ReAct 或 Plan 模式
    - 协调 ContextManager、ToolRegistry 和 LLMAdapter
    - 实现 cancel() 用于操作取消
    - 实现 getState() 获取当前状态
    - _需求: 2.1, 3.1, 7.1_
  - [ ]* 11.2 编写 AgentEngine 单元测试
    - 测试模式路由
    - 测试取消
    - 测试状态管理
    - _需求: 2.1, 3.1_

- [x] 12. 实现 VSCode 扩展集成
  - [x] 12.1 创建 ChatPanelProvider
    - 实现侧边栏面板的 WebviewViewProvider
    - 创建聊天 UI 的 HTML/CSS/JS
    - 处理 webview 和扩展之间的消息传递
    - _需求: 1.1, 1.2, 1.3_
  - [x] 12.2 实现消息处理
    - 处理用户消息并发送到 AgentEngine
    - 将 AgentEvents 流式传输到 webview
    - 处理工具调用显示
    - _需求: 1.2, 9.1, 9.2, 9.3, 9.4, 9.5_
  - [x] 12.3 实现配置管理
    - 在 package.json 中创建设置模式
    - 实现设置 UI
    - 使用 VSCode SecretStorage 存储 API 密钥
    - _需求: 6.1, 6.5_
  - [x] 12.4 实现对话持久化
    - 将对话保存到工作区存储
    - 在扩展激活时恢复对话
    - _需求: 1.5, 11.1, 11.2_
  - [x] 12.5 实现工作区感知
    - 跟踪活动文件和选择
    - 扫描工作区获取项目信息
    - _需求: 8.1, 8.3, 8.4, 8.5_
  - [ ]* 12.6 编写 VSCode 集成单元测试
    - 测试 ChatPanelProvider
    - 测试消息处理
    - 测试配置管理
    - _需求: 1.1, 1.2, 6.1_

- [x] 13. 实现流式传输和取消
  - [x] 13.1 添加聊天 UI 流式支持
    - 在 token 到达时显示
    - 在流式传输期间显示打字指示器
    - _需求: 10.1, 10.2_
  - [x] 13.2 实现取消 UI
    - 在操作期间添加取消按钮
    - 处理部分响应显示
    - _需求: 10.3, 10.4_
  - [ ]* 13.3 编写流式传输单元测试
    - 测试 token 流式显示
    - 测试取消行为
    - _需求: 10.1, 10.3_

- [ ] 14. 最终检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户。
